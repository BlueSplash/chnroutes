#!/usr/bin/env python

import re
import urllib2
import sys

METRIC=5

#fetch data from apnic
print "Fetching data from apnic.net, it might take a few minutes, please wait..."
url=r'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'
data=urllib2.urlopen(url).read()

# including all the allocated and assigned data
cnregex=re.compile(r'apnic\|cn\|ipv4\|[0-9\.]+\|[0-9]+\|[0-9]+\|a.*',re.IGNORECASE)
cndata=cnregex.findall(data)

routes_file=open('routes.txt','w')

for item in cndata:
    unit_items=item.split('|')
    starting_ip=unit_items[3]
    num_ip=int(unit_items[4])
    
    imask=0xffffffff^(num_ip-1)
    #convert to string
    imask=hex(imask)[2:]
    masks=[0]*4
    masks[0]=imask[0:2]
    masks[1]=imask[2:4]
    masks[2]=imask[4:6]
    masks[3]=imask[6:8]
    
    #convert str to int
    masks=[ int(i,16 ) for i in masks]
    
    mask="%d.%d.%d.%d"%tuple(masks)
    
    route_item="route %s %s net_gateway %d\n"%(starting_ip,mask,METRIC)
    routes_file.write(route_item)

routes_file.close()

print "Usage: Append the content of the newly created routes.txt to your openvpn config file," \
      " and also add 'max-routes %d', which takes a line, to the head of the file." % (len(cndata)+50)
